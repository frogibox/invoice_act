# Учет счетов и актов

> Этот проект создан методом vibe coding — полностью сгенерирован ИИ-агентом.

Веб-приложение для учета выставленных счетов (из 1С) и подписанных актов (из СБИС), их связывания (мэтчинга), контроля оплаты и отслеживания KPI ответственных сотрудников.

## Возможности

- Импорт счетов из Excel (1С)
- Импорт актов из Excel (СБИС)
- Автоматическая нормализация названий контрагентов
- Привязка актов к счетам (мэтчинг)
- Отслеживание статуса оплаты
- Управление списком сотрудников
- Фильтрация импорта по стоп-словам и ответственным

## Установка

Процесс автоматизирован, предварительное скачивание файлов не требуется.

1. Нажмите **Win + R**, чтобы открыть окно «Выполнить».
2. Скопируйте команду ниже, вставьте в поле ввода и нажмите **Enter**:
   ```powershell
   powershell -NoExit -ExecutionPolicy ByPass -c "irm https://raw.githubusercontent.com/frogibox/invoice_act/main/install.ps1 | iex"
   ```
3. Откроется окно PowerShell. Появится запрос пути для установки — введите нужный путь или нажмите **Enter** для установки в папку по умолчанию.
4. Дождитесь сообщения об успешном завершении. Окно можно закрыть.

## Запуск

1. Откройте папку, которую указали при установке.
2. Запустите файл **`run.bat`** двойным щелчком.
3. Не закрывайте появившееся черное окно командной строки (оно поддерживает работу сервера).
4. Откройте браузер и перейдите по адресу: **http://127.0.0.1:8000**

## Обновление

1. Откройте папку с установленным приложением.
2. Запустите файл **`update.bat`**.
3. Скрипт скачает актуальную версию с сервера, сохранит локальные данные и перезапустит приложение.

## Логика фильтрации при импорте из 1С

### Уровень 1 (Отсев мусора)
- Если сумма == 0 или пустая — строка пропускается
- Если комментарий содержит "удалить" или "заглушка" — строка пропускается

### Уровень 2 (Проверка ответственного)
- Если ответственный входит в список сотрудников отдела "РПО/Продажи" — строка сохраняется
- ИЛИ если в комментарии найдена фамилия из списка — строка сохраняется
- Иначе — строка пропускается

### Уровень 3 (Стоп-слова)
- Если в комментарии есть любое стоп-слово — строка пропускается

## Логика фильтрации при импорте из СБИС

### Условия импорта
- Тип документа "ЭДОСч" — всегда пропускается
- Тип пакета "ДокОтгрИсх" — импортируется независимо от типа документа
- Статус документа должен быть "Выполнение завершено успешно"
- Дата подписания (Завершено) должна быть заполнена
- Для строк с типом пакета "ДокОтгрИсх" сумма может быть нулевой

## Нормализация названий контрагентов

При импорте название контрагента приводится к единому формату:
1. Удаляются лишние знаки препинания (кавычки, запятые)
2. Юридическая форма (ООО, ИП, АО, ЗАО) выносится в конец строки
3. Удаляются дополнения в скобках

Примеры:
- `ТехноДрайв"СТРОЙ"ООО` → `ТехноДрайв СТРОЙ ООО`
- `СервисПлюс, ООО` → `СервисПлюс ООО`
- `ГарантСтрой, ООО (Склад)` → `ГарантСтрой ООО`

## Статусы счетов

- **Не оплачен**: сумма актов равна 0 или нет привязанных актов
- **Частично**: сумма актов < суммы счета
- **Оплачен**: сумма актов = сумме счета
- **Ошибка суммы**: сумма актов > суммы счета (требует внимания)

## Управление базой данных

### Очистка базы данных
Запустите `clear_database.bat` — создастся backup в папке `backups/`, база будет очищена и пересоздана.

### Восстановление из backup
Запустите `restore_database.bat` — скрипт покажет список доступных бэкапов и предложит выбрать номер для восстановления.

## Структура проекта

```
├── src/
│   ├── __init__.py
│   ├── database.py      # Модели БД
│   ├── main.py          # Приложение FastAPI
│   └── templates/       # HTML шаблоны
│       ├── dashboard.html
│       ├── unlinked_acts.html
│       ├── linked_acts.html
│       ├── import.html
│       ├── employees.html
│       └── nav.html
├── pyproject.toml       # Зависимости
├── install.ps1          # Установка с нуля (через Win+R)
├── run.bat              # Запуск приложения
├── update.bat           # Обновление из GitHub
├── clear_database.bat   # Очистка БД
└── restore_database.bat # Восстановление БД
```
